@page "/ssealconfigurator"
@using SSealEngine
@inject SSealEngine SSealEngine
@inject IJSRuntime JS

<h3>S-Seal Configurator (Parametric)</h3>

<div id="configuratorArea" class="dark-card" style="max-width:720px;padding:16px;">
    <div class="row">
        <div class="col-6">
            <label>Seal Type (informational)</label>
            <select @bind="SealType" class="form-control">
                <option>Face Seal - Internal Pressure</option>
                <option>Face Seal - External Pressure</option>
                <option>Flange Seal</option>
            </select>

            <label class="mt-2">Bore Ø (mm)</label>
            <input type="number" @bind="Bore" class="form-control" />

            <label class="mt-2">Groove CS (mm)</label>
            <input type="number" step="0.1" @bind="Groove" class="form-control" />

            <label class="mt-2">Medium</label>
            <input type="text" @bind="Medium" class="form-control" />

            <label class="mt-2">Preferred Material (optional)</label>
            <input type="text" @bind="PreferredMaterial" placeholder="e.g. FKM" class="form-control" />
        </div>

        <div class="col-6">
            <label>Max Temp (°C)</label>
            <input type="number" @bind="Temp" class="form-control" />

            <label class="mt-2">System Pressure (bar)</label>
            <input type="number" @bind="SystemPressure" class="form-control" />

            <label class="mt-2">Motion</label>
            <select @bind="Motion" class="form-control">
                <option value="MotionType.Static">Static</option>
                <option value="MotionType.Dynamic">Dynamic</option>
                <option value="MotionType.Both">Both</option>
            </select>

            <label class="mt-2">Surface Speed (m/s) - for dynamic</label>
            <input type="number" step="0.1" @bind="Speed" class="form-control" />
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-primary" @onclick="RunRecommend">Recommend</button>
        <button class="btn btn-success ms-2" @onclick="ExportPdf">Export PDF</button>
    </div>

    <hr />

    @if (LastResultFound)
    {
        <div class="result-box">
            <h5>Recommendation</h5>
            <p><strong>Part:</strong> @Recommended?.PartNumber</p>
            <p><strong>ID:</strong> @Recommended?.ID_mm mm &nbsp; <strong>CS:</strong> @Recommended?.CS_mm mm</p>
            <p><strong>Rated Pressure:</strong> @Recommended?.MaxPressure_bar bar at @Recommended?.MaxTemp_C °C</p>
            <p><strong>Derated Allowable Pressure at @Temp °C:</strong> @DeratedAllow:F2 bar</p>
            <p><strong>Material Compatible:</strong> @(Recommended != null ? (SSealEngine.IsMaterialCompatible(Recommended, PreferredMaterial ?? "") ? "Yes" : "Check") : "N/A")</p>
            <p><strong>Motion OK:</strong> @(Recommended != null ? (SSealEngine.IsMotionCompatible(Recommended, Motion, Speed) ? "Yes" : "No") : "N/A")</p>
            <p><strong>Score:</strong> @Score:F2</p>
            <pre style="background:#111;padding:10px;color:#9f9">@Reason</pre>
        </div>
    }
    else if (TriedRun)
    {
        <div class="alert alert-warning">No suitable seal found for given constraints.</div>
    }

    <hr />

    <h5>Preset Seal Catalog</h5>
    <table class="table table-sm table-dark">
        <thead>
            <tr><th>Part</th><th>ID</th><th>CS</th><th>OD</th><th>MaxP</th><th>MaxT</th><th>Materials</th><th>Motion</th></tr>
        </thead>
        <tbody>
            @foreach(var s in SSealEngine.Catalog)
            {
                <tr>
                    <td>@s.PartNumber</td>
                    <td>@s.ID_mm</td>
                    <td>@s.CS_mm</td>
                    <td>@s.OD_mm</td>
                    <td>@s.MaxPressure_bar</td>
                    <td>@s.MaxTemp_C</td>
                    <td>@string.Join(", ", s.CompatibleMaterials)</td>
                    <td>@s.MotionCompatibility</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private string SealType { get; set; } = "Face Seal - Internal Pressure";
    private double Bore { get; set; } = 100;
    private double Groove { get; set; } = 4.0;
    private string Medium { get; set; } = "Hydraulic Oil";
    private string? PreferredMaterial { get; set; } = "";
    private int Temp { get; set; } = 120;
    private double SystemPressure { get; set; } = 100;
    private MotionType Motion { get; set; } = MotionType.Both;
    private double Speed { get; set; } = 0;

    private bool TriedRun;
    private bool LastResultFound;
    private SealSize? Recommended;
    private double Score;
    private string Reason = "";
    private double DeratedAllow;

    private void RunRecommend()
    {
        TriedRun = true;
        var (best, score, reason) = SSealEngine.RecommendSeal(
            Bore, Groove, Temp, Medium,
            SystemPressure, Motion, Speed,
            string.IsNullOrWhiteSpace(PreferredMaterial) ? null : new [] { PreferredMaterial });

        Recommended = best;
        LastResultFound = best != null;
        Score = score;
        Reason = reason ?? "";
        DeratedAllow = best != null ? SSealEngine.DeratePressure(best, Temp) : 0;
    }

    private async Task ExportPdf()
    {
        await JS.InvokeVoidAsync("exportPdf", "configuratorArea");
    }
}
